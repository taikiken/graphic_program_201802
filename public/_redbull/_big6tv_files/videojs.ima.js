/**
 * Copyright 2014 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * IMA SDK integration plugin for Video.js. For more information see
 * https://www.github.com/googleads/videojs-ima
 */
!function(t){"use strict";var e=function(t){var e,i,s;for(i=1;i<arguments.length;i++){e=arguments[i];for(s in e)e.hasOwnProperty(s)&&(t[s]=e[s])}return t},i={debug:!1,timeout:5e3,prerollTimeout:100,adLabel:"Advertisement",showControlsForJSAds:!0},s=function(t,e){this.ima=new n(this,t,e)},n=function(t,s,n){this.player=t;var a=function(t,e){t.id=this.controlPrefix+e,t.className=this.controlPrefix+e+" "+e}.bind(this),d=function(t){return new RegExp("\\b"+t+"\\b","gi")},r=function(t,e){return d(e).test(t.className)?t:t.className=t.className.trim()+" "+e},h=function(t,e){var i=d(e);return i.test(t.className)?t.className=t.className.trim().replace(i,""):t},o=function(){this.vjsControls=this.player.getChild("controlBar"),this.adContainerDiv=this.vjsControls.el().parentNode.appendChild(document.createElement("div")),a(this.adContainerDiv,"ima-ad-container"),this.adContainerDiv.style.position="absolute",this.adContainerDiv.style.zIndex=1111,this.adContainerDiv.addEventListener("mouseenter",f,!1),this.adContainerDiv.addEventListener("mouseleave",A,!1),l(),this.adDisplayContainer=new google.ima.AdDisplayContainer(this.adContainerDiv,this.contentPlayer)}.bind(this),l=function(){this.controlsDiv=document.createElement("div"),a(this.controlsDiv,"ima-controls-div"),this.controlsDiv.style.width="100%",this.countdownDiv=document.createElement("div"),a(this.countdownDiv,"ima-countdown-div"),this.countdownDiv.innerHTML=this.settings.adLabel,this.countdownDiv.style.display=this.showCountdown?"block":"none",this.seekBarDiv=document.createElement("div"),a(this.seekBarDiv,"ima-seek-bar-div"),this.seekBarDiv.style.width="100%",this.progressDiv=document.createElement("div"),a(this.progressDiv,"ima-progress-div"),this.playPauseDiv=document.createElement("div"),a(this.playPauseDiv,"ima-play-pause-div"),r(this.playPauseDiv,"ima-playing"),this.playPauseDiv.addEventListener("click",C,!1),this.muteDiv=document.createElement("div"),a(this.muteDiv,"ima-mute-div"),r(this.muteDiv,"ima-non-muted"),this.muteDiv.addEventListener("click",L,!1),this.sliderDiv=document.createElement("div"),a(this.sliderDiv,"ima-slider-div"),this.sliderDiv.addEventListener("mousedown",E,!1),this.sliderLevelDiv=document.createElement("div"),a(this.sliderLevelDiv,"ima-slider-level-div"),this.fullscreenDiv=document.createElement("div"),a(this.fullscreenDiv,"ima-fullscreen-div"),r(this.fullscreenDiv,"ima-non-fullscreen"),this.fullscreenDiv.addEventListener("click",T,!1),this.adContainerDiv.appendChild(this.controlsDiv),this.controlsDiv.appendChild(this.countdownDiv),this.controlsDiv.appendChild(this.seekBarDiv),this.controlsDiv.appendChild(this.playPauseDiv),this.controlsDiv.appendChild(this.muteDiv),this.controlsDiv.appendChild(this.sliderDiv),this.controlsDiv.appendChild(this.fullscreenDiv),this.seekBarDiv.appendChild(this.progressDiv),this.sliderDiv.appendChild(this.sliderLevelDiv)}.bind(this);this.initializeAdDisplayContainer=function(){this.adDisplayContainerInitialized=!0,this.adDisplayContainer.initialize()}.bind(this),this.requestAds=function(){this.adDisplayContainerInitialized||this.adDisplayContainer.initialize();var t=new google.ima.AdsRequest;this.settings.adTagUrl?t.adTagUrl=this.settings.adTagUrl:t.adsResponse=this.settings.adsResponse,this.settings.forceNonLinearFullSlot&&(t.forceNonLinearFullSlot=!0),t.linearAdSlotWidth=this.getPlayerWidth(),t.linearAdSlotHeight=this.getPlayerHeight(),t.nonLinearAdSlotWidth=this.settings.nonLinearWidth||this.getPlayerWidth(),t.nonLinearAdSlotHeight=this.settings.nonLinearHeight||this.getPlayerHeight()/3,this.adsLoader.requestAds(t)}.bind(this);var u=function(t){if(this.adsManager=t.getAdsManager(this.contentPlayheadTracker,this.adsRenderingSettings),this.adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,g),this.adsManager.addEventListener(google.ima.AdEvent.Type.AD_BREAK_READY,v),this.adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,this.onContentPauseRequested_),this.adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,this.onContentResumeRequested_),this.adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED,m),this.adsManager.addEventListener(google.ima.AdEvent.Type.LOADED,p),this.adsManager.addEventListener(google.ima.AdEvent.Type.STARTED,y),this.adsManager.addEventListener(google.ima.AdEvent.Type.CLICK,C),this.adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE,this.onAdComplete_),this.adsManager.addEventListener(google.ima.AdEvent.Type.SKIPPED,this.onAdComplete_),!this.autoPlayAdBreaks)try{var e=this.getPlayerWidth(),i=this.getPlayerHeight();this.adsManagerDimensions.width=e,this.adsManagerDimensions.height=i,this.adsManager.init(e,i,google.ima.ViewMode.NORMAL),this.adsManager.setVolume(this.player.muted()?0:this.player.volume())}catch(s){g(s)}this.player.trigger("adsready")}.bind(this);this.start=function(){},this.startFromReadyCallback=function(){if(this.autoPlayAdBreaks)try{this.adsManager.init(this.getPlayerWidth(),this.getPlayerHeight(),google.ima.ViewMode.NORMAL),this.adsManager.setVolume(this.player.muted()?0:this.player.volume()),this.adsManager.start()}catch(t){this.onAdError_(t)}}.bind(this);var c=function(t){this.adContainerDiv.style.display="none",this.adsManager&&this.adsManager.destroy(),this.player.trigger({type:"adserror",data:{AdError:t.getError(),AdErrorEvent:t}})}.bind(this),g=function(t){this.vjsControls.show(),this.adsManager.destroy(),this.adContainerDiv.style.display="none",this.player.trigger({type:"adserror",data:{AdError:t.getError(),AdErrorEvent:t}})}.bind(this),v=function(t){this.adBreakReadyListener(t)}.bind(this);this.playAdBreak=function(){this.autoPlayAdBreaks||this.adsManager.start()}.bind(this),this.onContentPauseRequested_=function(t){this.adsActive=!0,this.adPlaying=!0,this.player.off("ended",this.localContentEndedListener),-1!=t.getAd().getAdPodInfo().getPodIndex()&&this.player.ads.startLinearAdMode(),this.adContainerDiv.style.display="block";var e=t.getAd().getContentType();"application/javascript"!==e||this.settings.showControlsForJSAds?this.controlsDiv.style.display="block":this.controlsDiv.style.display="none",this.vjsControls.hide(),this.player.pause()}.bind(this),this.onContentResumeRequested_=function(t){this.adsActive=!1,this.adPlaying=!1,this.player.on("ended",this.localContentEndedListener),(null==this.currentAd||this.currentAd.isLinear())&&(this.adContainerDiv.style.display="none"),this.vjsControls.show(),this.currentAd?this.contentComplete||-1==this.currentAd.getAdPodInfo().getPodIndex()||this.player.ads.endLinearAdMode():this.player.ads.endLinearAdMode(),this.countdownDiv.innerHTML=""}.bind(this);var m=function(t){if(this.allAdsCompleted=!0,1==this.contentComplete)for(var e in this.contentAndAdsEndedListeners)this.contentAndAdsEndedListeners[e]()}.bind(this),p=function(t){t.getAd().isLinear()||this.player.play()}.bind(this),y=function(t){this.currentAd=t.getAd(),this.currentAd.isLinear()?(this.adTrackingTimer=setInterval(D,250),h(this.adContainerDiv,"bumpable-ima-ad-container")):r(this.adContainerDiv,"bumpable-ima-ad-container")}.bind(this);this.onAdComplete_=function(t){this.currentAd.isLinear()&&clearInterval(this.adTrackingTimer)}.bind(this);var D=function(){var t=this.adsManager.getRemainingTime(),e=this.currentAd.getDuration(),i=e-t;i=i>0?i:0;var s,n=!1,a=0;this.currentAd.getAdPodInfo()&&(n=!0,s=this.currentAd.getAdPodInfo().getAdPosition(),a=this.currentAd.getAdPodInfo().getTotalAds());var d=Math.floor(t/60),r=Math.floor(t%60);r.toString().length<2&&(r="0"+r);var h=": ";n&&a>1&&(h=" ("+s+" of "+a+"): "),this.countdownDiv.innerHTML=this.settings.adLabel+h+d+":"+r;var o=i/e,l=100*o;this.progressDiv.style.width=l+"%"}.bind(this);this.getPlayerWidth=function(){var t=parseInt(getComputedStyle(this.player.el()).width,10)||this.player.width();return t}.bind(this),this.getPlayerHeight=function(){var t=parseInt(getComputedStyle(this.player.el()).height,10)||this.player.height();return t}.bind(this);var A=function(){this.controlsDiv.style.height="14px",this.playPauseDiv.style.display="none",this.muteDiv.style.display="none",this.sliderDiv.style.display="none",this.fullscreenDiv.style.display="none"}.bind(this),f=function(){this.controlsDiv.style.height="37px",this.playPauseDiv.style.display="block",this.muteDiv.style.display="block",this.sliderDiv.style.display="block",this.fullscreenDiv.style.display="block"}.bind(this),C=function(){this.adPlaying?(r(this.playPauseDiv,"ima-paused"),h(this.playPauseDiv,"ima-playing"),this.adsManager.pause(),this.adPlaying=!1):(r(this.playPauseDiv,"ima-playing"),h(this.playPauseDiv,"ima-paused"),this.adsManager.resume(),this.adPlaying=!0)}.bind(this),L=function(){this.adMuted?(r(this.muteDiv,"ima-non-muted"),h(this.muteDiv,"ima-muted"),this.adsManager.setVolume(1),this.player.muted(!1),this.adMuted=!1,this.sliderLevelDiv.style.width=100*this.player.volume()+"%"):(r(this.muteDiv,"ima-muted"),h(this.muteDiv,"ima-non-muted"),this.adsManager.setVolume(0),this.player.muted(!0),this.adMuted=!0,this.sliderLevelDiv.style.width="0%")}.bind(this),E=function(){document.addEventListener("mouseup",P,!1),document.addEventListener("mousemove",M,!1)},M=function(t){k(t)},P=function(t){k(t),document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",P)},k=function(t){var e=(t.clientX-this.sliderDiv.getBoundingClientRect().left)/this.sliderDiv.offsetWidth;e*=100,e=Math.min(Math.max(e,0),100),this.sliderLevelDiv.style.width=e+"%",this.player.volume(e/100),this.adsManager.setVolume(e/100),0==this.player.volume()?(r(this.muteDiv,"ima-muted"),h(this.muteDiv,"ima-non-muted"),this.player.muted(!0),this.adMuted=!0):(r(this.muteDiv,"ima-non-muted"),h(this.muteDiv,"ima-muted"),this.player.muted(!1),this.adMuted=!1)}.bind(this),T=function(){this.player.isFullscreen()?this.player.exitFullscreen():this.player.requestFullscreen()}.bind(this),b=function(){this.player.isFullscreen()?(r(this.fullscreenDiv,"ima-fullscreen"),h(this.fullscreenDiv,"ima-non-fullscreen"),this.adsManager&&this.adsManager.resize(window.screen.width,window.screen.height,google.ima.ViewMode.FULLSCREEN)):(r(this.fullscreenDiv,"ima-non-fullscreen"),h(this.fullscreenDiv,"ima-fullscreen"),this.adsManager&&this.adsManager.resize(this.getPlayerWidth(),this.getPlayerHeight(),google.ima.ViewMode.NORMAL))}.bind(this),w=function(){var t=this.player.muted()?0:this.player.volume();this.adsManager&&this.adsManager.setVolume(t),0==this.newVolume?(this.adMuted=!0,r(this.muteDiv,"ima-muted"),h(this.muteDiv,"ima-non-muted"),this.sliderLevelDiv.style.width="0%"):(this.adMuted=!1,r(this.muteDiv,"ima-non-muted"),h(this.muteDiv,"ima-muted"),this.sliderLevelDiv.style.width=100*t+"%")}.bind(this),R=function(){this.player.off("loadedmetadata",R),this.player.currentTime(0)}.bind(this),I=function(){this.player.off("loadedmetadata",I),this.player.currentTime(0),this.player.play()}.bind(this),S=function(){this.adsActive=!1,this.adPlaying=!1,this.player.on("ended",this.localContentEndedListener),this.currentAd&&this.currentAd.isLinear()&&(this.adContainerDiv.style.display="none"),this.vjsControls.show(),this.player.ads.endLinearAdMode(),this.adTrackingTimer&&clearInterval(this.adTrackingTimer),this.adsManager&&(this.adsManager.destroy(),this.adsManager=null),this.adsLoader&&!this.contentComplete&&this.adsLoader.contentComplete(),this.contentComplete=!1,this.allAdsCompleted=!1}.bind(this);this.addEventListener=function(t,e){this.adsManager&&this.adsManager.addEventListener(t,e)}.bind(this),this.getAdsManager=function(){return this.adsManager}.bind(this),this.setContent=function(t,e,i){this.setContentWithAdTag(t,e,i)}.bind(this),this.setContentWithAdTag=function(t,e,i){S(),this.settings.adTagUrl=e?e:this.settings.adTagUrl,B(t,i)}.bind(this),this.setContentWithAdsResponse=function(t,e,i){S(),this.settings.adsResponse=e?e:this.settings.adsResponse,B(t,i)}.bind(this);var B=function(t,e){this.player.currentSrc()&&(this.player.currentTime(0),this.player.pause()),t&&this.player.src(t),e?this.player.on("loadedmetadata",I):this.player.on("loadedmetadata",R)}.bind(this);this.addContentEndedListener=function(t){this.contentEndedListeners.push(t)}.bind(this),this.addContentAndAdsEndedListener=function(t){this.contentAndAdsEndedListeners.push(t)}.bind(this),this.setAdBreakReadyListener=function(t){this.adBreakReadyListener=t}.bind(this),this.pauseAd=function(){this.adsActive&&this.adPlaying&&(r(this.playPauseDiv,"ima-paused"),h(this.playPauseDiv,"ima-playing"),this.adsManager.pause(),this.adPlaying=!1)}.bind(this),this.resumeAd=function(){this.adsActive&&!this.adPlaying&&(r(this.playPauseDiv,"ima-playing"),h(this.playPauseDiv,"ima-paused"),this.adsManager.resume(),this.adPlaying=!0)}.bind(this);var H=function(){this.updateTimeIntervalHandle=setInterval(N,this.seekCheckInterval),this.seekCheckIntervalHandle=setInterval(_,this.seekCheckInterval),this.resizeCheckIntervalHandle=setInterval(V,this.resizeCheckInterval)}.bind(this),N=function(){this.contentPlayheadTracker.seeking||(this.contentPlayheadTracker.currentTime=this.player.currentTime())}.bind(this),_=function(){var t=this.player.currentTime(),e=1e3*(t-this.contentPlayheadTracker.previousTime);Math.abs(e)>this.seekCheckInterval+this.seekThreshold?this.contentPlayheadTracker.seeking=!0:this.contentPlayheadTracker.seeking=!1,this.contentPlayheadTracker.previousTime=this.player.currentTime()}.bind(this),V=function(){var t=this.getPlayerWidth(),e=this.getPlayerHeight();!this.adsManager||t==this.adsManagerDimensions.width&&e==this.adsManagerDimensions.height||(this.adsManagerDimensions.width=t,this.adsManagerDimensions.height=e,this.adsManager.resize(t,e,google.ima.ViewMode.NORMAL))}.bind(this);if(this.setShowCountdown=function(t){this.showCountdown=t,this.countdownDiv.style.display=this.showCountdown?"block":"none"}.bind(this),this.VERSION="0.2.0",this.settings,this.controlPrefix,this.contentPlayer,this.showCountdown,this.autoPlayAdBreaks,this.vjsControls,this.adContainerDiv,this.controlsDiv,this.countdownDiv,this.seekBarDiv,this.progressDiv,this.playPauseDiv,this.muteDiv,this.sliderDiv,this.sliderLevelDiv,this.fullscreenDiv,this.adDisplayContainer,this.adDisplayContainerInitialized=!1,this.adsLoader,this.adsManager,this.adsRenderingSettings=null,this.adTagUrl,this.adsResponse,this.currentAd,this.contentTrackingTimer,this.adTrackingTimer,this.adsActive=!1,this.adPlaying=!1,this.adMuted=!1,this.contentComplete=!1,this.allAdsCompleted=!1,this.updateTimeIntervalHandle,this.seekCheckIntervalHandle,this.seekCheckInterval=1e3,this.resizeCheckIntervalHandle,this.resizeCheckInterval=250,this.seekThreshold=100,this.contentPlayheadTracker={currentTime:0,previousTime:0,seeking:!1,duration:0},this.adPlayheadTracker={currentTime:0,duration:0,isPod:!1,adPosition:0,totalAds:0},this.adsManagerDimensions={width:0,height:0},this.contentEndedListeners=[],this.contentAndAdsEndedListeners=[],this.adBreakReadyListener=void 0,this.localContentEndedListener=function(){this.adsLoader&&!this.contentComplete&&(this.adsLoader.contentComplete(),this.contentComplete=!0);for(var t in this.contentEndedListeners)this.contentEndedListeners[t]();if(this.allAdsCompleted)for(var t in this.contentAndAdsEndedListeners)this.contentAndAdsEndedListeners[t]();clearInterval(this.updateTimeIntervalHandle),clearInterval(this.seekCheckIntervalHandle),clearInterval(this.resizeCheckIntervalHandle),this.player.el()&&this.player.one("play",H)}.bind(this),this.playerDisposedListener=function(){this.contentEndedListeners,this.contentAndAdsEndedListeners=[],[],this.contentComplete=!0,this.player.off("ended",this.localContentEndedListener);var t=[this.updateTimeIntervalHandle,this.seekCheckIntervalHandle,this.adTrackingTimer,this.resizeCheckIntervalHandle];for(var e in t){var i=t[e];i&&clearInterval(i)}this.adsManager&&(this.adsManager.destroy(),this.adsManager=null)}.bind(this),this.settings=e({},i,s||{}),this.settings.id){this.controlPrefix=this.settings.id+"_"||"",this.contentPlayer=document.getElementById(this.settings.id+"_html5_api"),this.showCountdown=!0,0==this.settings.showCountdown&&(this.showCountdown=!1),this.autoPlayAdBreaks=!0,0==this.settings.autoPlayAdBreaks&&(this.autoPlayAdBreaks=!1),t.one("play",H),t.on("ended",this.localContentEndedListener),t.on("dispose",this.playerDisposedListener);var z={debug:this.settings.debug,timeout:this.settings.timeout,prerollTimeout:this.settings.prerollTimeout},O=e({},z,s.contribAdsSettings||{});if(t.ads(O),this.adsRenderingSettings=new google.ima.AdsRenderingSettings,this.adsRenderingSettings.restoreCustomPlaybackStateOnAdBreakComplete=!0,this.settings.adsRenderingSettings)for(var W in this.settings.adsRenderingSettings)this.adsRenderingSettings[W]=this.settings.adsRenderingSettings[W];this.settings.locale&&google.ima.settings.setLocale(this.settings.locale),o(),this.adsLoader=new google.ima.AdsLoader(this.adDisplayContainer),this.adsLoader.getSettings().setVpaidMode(google.ima.ImaSdkSettings.VpaidMode.ENABLED),0==this.settings.vpaidAllowed&&this.adsLoader.getSettings().setVpaidMode(google.ima.ImaSdkSettings.VpaidMode.DISABLED),this.settings.vpaidMode&&this.adsLoader.getSettings().setVpaidMode(this.settings.vpaidMode),this.settings.locale&&this.adsLoader.getSettings().setLocale(this.settings.locale),this.settings.numRedirects&&this.adsLoader.getSettings().setNumRedirects(this.settings.numRedirects),this.adsLoader.getSettings().setPlayerType("videojs-ima"),this.adsLoader.getSettings().setPlayerVersion(this.VERSION),this.adsLoader.getSettings().setAutoPlayAdBreaks(this.autoPlayAdBreaks),this.adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,u,!1),this.adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,c,!1),n||(n=this.startFromReadyCallback),t.on("readyforpreroll",n),t.ready(function(){t.on("fullscreenchange",b),t.on("volumechange",w)})}};t.plugin("ima",s)}(window.videojs);